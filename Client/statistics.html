<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Movie Links & Reviews</title>

  <link rel="stylesheet" href="statistics.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <script type="text/javascript" src="main.js"></script>

  <h6 id="welcome-message">Welcome, <span id="username-display"> </span></h6>
  <button id="logout-button" class="btn btn-danger">Logout</button>

  <div>
    <h1>Statistics</h1>
  </div>
  <div class="container d-flex justify-content-between align-items-center">
    <div>
        <button id="all-favorites" class="btn btn-secondary">My Favorites</button>
        <button id="top-links" class="btn btn-secondary">Top Links</button>
        <button id="statistics" class="btn btn-secondary">
            <a href="/statistics">Statistics</a>
        </button>
    </div>
    <button id="admin-panel-button" class="btn btn-warning" style="display: none">
        Admin Panel
    </button>
</div>
  <div class="body_wrapper">
    <div class="in_wrapper">
      <div class="stats-container">
        <div class="stat-box">
          <span>Total Users</span>
          <span class="stat-number" id="total-users">0</span>
        </div>

        <div class="stat-box">
          <span>Total Reviews</span>
          <span class="stat-number" id="total-reviews">0</span>
        </div>

        <div class="stat-box">
          <span>Total Users Who Added Links</span>
          <span class="stat-number" id="total-users-links">0</span>
        </div>
      </div>
      <div id="chart_wrapper">
        <span>Users joined in the last days:</span>
        <div id="chart_div"></div>
      </div>
      <div class="stat-section-wrapper">
        <div class="stat-section">
          <div class="stat-title">Review Statistics</div>
          <div class="stat-divs">
            <div class="stat-percentage">
              <span id="review-percentage">0%</span>
              <span id="users-added">Of users added a review </span>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Top reviewers</th>
                </tr>
              </thead>
              <tbody id="top-reviews">
                <!-- Top 3 reviews will be inserted here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Link Statistics -->
        <div class="stat-section">
          <div class="stat-title">Link Statistics</div>
          <div class="stat-divs">
            <div class="stat-percentage">
              Percentage of Users Who Added Links:
              <div class="percentage-wrapper">
                <span id="link-percentage"></span>
              </div>
            </div>

            <table>
              <thead>
                <tr>
                  <th>Most Linked Movie/Series</th>
                </tr>
              </thead>
              <tbody id="top-movie-links">
                <tr>
                  <td><img id="top-movie-image" src="" /></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    async function fetchStats() {
      try {
        const response = await fetch("/stats"); // Backend API to get statistics
        const data = await response.json();
        const { stats } = data;

        const reviewersTable = document.getElementById("top-reviews")
        stats.reviewers.forEach((review) => {
          const name = review._id

          const tr = document.createElement('tr')
          tr.innerHTML = `<td>${name}</td>`
          reviewersTable.appendChild(tr)
        })

        document.getElementById("total-users").textContent = stats.users;
        document.getElementById("total-reviews").textContent = stats.reviews;
        document.getElementById("total-users-links").textContent =
          stats.links;

        document.getElementById("link-percentage").textContent =
          stats.linkPercentage + "%";
        document.getElementById("review-percentage").textContent =
          stats.reviewPercentage + "%";

        const movieDetails = await MovieAPI.fetchMoviesDetails(
          stats.topLinkedMovie[0]._id
        );
        const td = document
          .getElementById("top-movie-image")
          .setAttribute("src", movieDetails.poster);
        return stats;
      } catch (error) {
        console.error("Error fetching stats:", error);
      }
    }

    async function loadGraphData() {
      const stats = await fetchStats(); // Load stats when page loads
      const chartData = stats.usersJoin.map((entry) => [
        new Date(entry._id),
        entry.count,
      ]);
      const drawWithData = drawBasic(chartData);
      return drawWithData;
    }

    //const drawWithData = loadGraphData();

    google.charts.load("current", { packages: ["corechart", "line"] });
    google.charts.setOnLoadCallback(loadGraphData);

    function drawBasic(dataRows) {
      console.log(dataRows);
      var data = new google.visualization.DataTable();
      data.addColumn("date", "date");
      data.addColumn("number", "new users");

      data.addRows(dataRows);

      var options = {
        hAxis: {
          title: "Time",
        },
        vAxis: {
          title: "Popularity",
        },
        chartArea: {
          backgroundColor: {
            fill: "#f9f9f9",
            opacity: 100,
          },
        },
        backgroundColor: {
          fill: "#f9f9f9",
        },
      };

      var chart = new google.visualization.LineChart(
        document.getElementById("chart_div")
      );

      chart.draw(data, options);
    }
  </script>
  <script src="index.js" defer></script>
</body>

</html>